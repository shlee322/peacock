{% raw %}
<script type="text/ng-template" id="entityModalContent.html">
    <div class="modal-header">
        <h3 class="modal-title">{{ entity_kind  }} - {{ entity_id }}</h3>
    </div>
    <div class="modal-body">
        <form class="form-inline" role="form">
            <div class="form-group">
                <input type="date" class="form-control" id="date" ng-model="formData.start_date" readonly>
            </div>
            <div class="form-group">
                <input type="time" class="form-control" id="time" ng-model="formData.start_time" readonly>
            </div>
            <div class="form-group">
                ~
            </div>
            <div class="form-group">
                <input type="date" class="form-control" id="date" ng-model="formData.end_date" readonly>
            </div>
            <div class="form-group">
                <input type="time" class="form-control" id="time" ng-model="formData.end_time" readonly>
            </div>
        </form>
        <table class="table table-condensed">
            <thead>
                <tr>
                    <th width="120px">Event</th>
                    <th width="*">Timeline</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="item in timeline | filter:{ type: '!unlink'}">
                    <td ng-if="item.type == 'link'">{{ item.target.kind }}</td>
                    <td ng-if="item.type == 'event'">{{ entity_kind }}.{{ item.event_name }}</td>
                    <td>
                        {{ item.timestamp | date:'HH:mm:ss.sss' }} -> {{ item.timestamp+item.timestamp_length | date:'HH:mm:ss.sss' }} {{ item.timestamp_length }}ms
                        <div class="progress">
                            <div class="progress-bar" style="margin-top: {{ (item.timestamp - start_timestamp) / (end_timestamp - start_timestamp) * 100  | ceil}}%; width: {{ (item.timestamp - start_timestamp) / (end_timestamp - start_timestamp) * 100 | ceil}}%">
                            </div>
                            <div class="progress-bar progress-bar-striped" style="width: {{ item.timestamp_length+1 / (end_timestamp - start_timestamp) * 100  | ceil}}%">
                                {{ item.timestamp_length }}ms
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</script>

<script type="application/javascript">
    /*
    peacock.config(function(WebSocketProvider){
        WebSocketProvider
          .prefix('')
          .uri("ws://localhost:7000/" + service_id);
    });*/
    peacock.filter('ceil', function() {
      return function(input) {
        return Math.ceil(input);
      };
    });
    peacock.controller('entityModalController', function ($scope, $modalInstance, $filter, $http, kind, id, timestamp) {
        $scope.entity_kind = kind;
        $scope.entity_id = id;


        timestamp += 500;
        var start_timestamp = timestamp - 1000;
        var end_timestamp = timestamp;
        $scope.start_timestamp = start_timestamp;
        $scope.end_timestamp = end_timestamp;

        $scope.formData = {};
        $scope.formData.start_date = $filter('date')(start_timestamp, 'yyyy-MM-dd');
        $scope.formData.start_time = $filter('date')(start_timestamp, 'HH:mm:ss');
        $scope.formData.end_date = $filter('date')(end_timestamp, 'yyyy-MM-dd');
        $scope.formData.end_time = $filter('date')(end_timestamp, 'HH:mm:ss');


        $http.get('/manager/' + service_id + '/eventviewer/_ajax/get_entity_timeline?kind=' + kind + '&id=' + id +
            '&start_timestamp=' +start_timestamp + '&end_timestamp='+ end_timestamp)
            .success(function (data){
                    var timeline = data.data;

                    var link_data = {};
                    var add_link = [];
                    for(var i=0; i<timeline.length; i++) {
                        if(timeline[i].type == 'link') {
                            var target = timeline[i].target.kind + '_' + timeline[i].target.id;
                            link_data[target] = timeline[i];
                        } else if(timeline[i].type == 'unlink') {
                            var target = timeline[i].target.kind + '_' + timeline[i].target.id;
                            var target_obj = link_data[target];
                            if(!target_obj) {
                                target_obj = {
                                    'type': 'link',
                                    'timestamp': start_timestamp,
                                    'target': {
                                        'kind': timeline[i].target.kind,
                                        'id': timeline[i].target.id
                                    }
                                };
                                link_data[target] = target_obj;
                                add_link.push(target_obj);
                            }

                            target_obj.timestamp_length = timeline[i].timestamp - target_obj.timestamp;
                        }
                    }

                    for(var key in link_data) {
                        if(link_data[key].timestamp_length === undefined) {
                            link_data[key].timestamp_length = end_timestamp - link_data[key].timestamp;
                        }
                    }

                    for(var i=0; i<add_link.length; i++) {
                        timeline.unshift(add_link[i]);
                    }

                    console.log(timeline);
                    $scope.timeline = timeline;
        });
    });

    function openEntityModal($modal, kind, id, timestamp) {
        var modalInstance = $modal.open({
            templateUrl: 'entityModalContent.html',
            controller: 'entityModalController',
            size:'lg',
            resolve: {
                kind:function() { return kind; },
                id:function() { return id; },
                timestamp:function() { return timestamp; }
            }
        });
    }
</script>
{% endraw %}
